const _0x315748=function(){const e={aCeNZ:"websocket",rasnq:"state",uPkrg:function(e,t){return e!==t},CCVfF:"nLCMi",oygvg:"thrsJ",bfMlh:function(e,t){return e===t},qhVxl:"YWgxZ",aWvsn:"AwowT",IOumj:"ouddj",mPRnU:"RCLqx"};let t=!0;return function(s,n){const i=e.qhVxl,r=e.aWvsn;if(e.IOumj!==e.mPRnU){const e=t?function(){if(n){if(i===r){let e=this.state;return this.state=_0x4f9a4e,this.emit("state",{newState:_0x56db6e,oldState:e,channel:this.channel}),!0}{const e=n.apply(s,arguments);return n=null,e}}}:function(){};return t=!1,e}return"websocket"}}(),_0x154562=_0x315748(this,function(){return _0x154562.toString().search("(((.+)+)+)+$").toString().constructor(_0x154562).search("(((.+)+)+)+$")});_0x154562(),(()=>{var e=Object.create,t=Object.defineProperty,s=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,i=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty;const o={exports:{}};var c,a,h,l,u=(o,c,a)=>(a=null!=o?e(i(o)):{},((e,i,o,c)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let a of n(i))r.call(e,a)||a===o||t(e,a,{get:()=>i[a],enumerable:!(c=s(i,a))||c.enumerable});return e})(!c&&o&&o.__esModule?a:t(a,"default",{value:o,enumerable:!0}),o)),_=(c=(e,t)=>{"use strict";var s,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};s=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}t.exports=o,t.exports.once=function(e,t){return new Promise(function(s,n){function i(s){e.removeListener(t,r),n(s)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",i),s([].slice.call(arguments))}const o={once:!0};var c,a,h;b(e,t,r,{once:!0}),"error"!==t&&(a=i,h=o,"function"==typeof(c=e).on&&b(c,"error",a,h))})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var c=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e,t,s,n){var i,r,c,h;if(a(s),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),r=e._events),c=r[t]),void 0===c)c=r[t]=s,++e._eventsCount;else if("function"==typeof c?c=r[t]=n?[s,c]:[c,s]:n?c.unshift(s):c.push(s),(i=void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners)>0&&c.length>i&&!c.warned){c.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=c.length,h=l,console&&console.warn&&console.warn(h)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,s){const n={fired:!1,wrapFn:void 0,target:e,type:t,listener:s};var i=l.bind(n);return i.listener=s,n.wrapFn=i,i}function _(e,t,s){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?s?[i.listener||i]:[i]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(i):p(i,i.length)}function d(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function p(e,t){for(var s=new Array(t),n=0;n<t;++n)s[n]=e[n];return s}function b(e,t,s,n){if("function"==typeof e.on)n.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(r){n.once&&e.removeEventListener(t,i),s(r)})}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return void 0===this._maxListeners?o.defaultMaxListeners:this._maxListeners},o.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var a=r[e];if(void 0===a)return!1;if("function"==typeof a)i(a,this,t);else{var h=a.length,l=p(a,h);for(s=0;s<h;++s)i(l[s],this,t)}return!0},o.prototype.addListener=function(e,t){return h(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return h(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},o.prototype.removeListener=function(e,t){var s,n,i,r,o;if(a(t),void 0===(n=this._events))return this;if(void 0===(s=n[e]))return this;if(s===t||s.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(i=-1,r=s.length-1;r>=0;r--)if(s[r]===t||s[r].listener===t){o=s[r].listener,i=r;break}if(i<0)return this;0===i?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,i),1===s.length&&(n[e]=s[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,s,n;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var i,r=Object.keys(s);for(n=0;n<r.length;++n)"removeListener"!==(i=r[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},o.prototype.listeners=function(e){return _(this,e,!0)},o.prototype.rawListeners=function(e){return _(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},o.prototype.listenerCount=d,o.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}},()=>(a||c((a=o).exports,a),a.exports)),d=u(_()),p=((h=p||{}).Disconnected="disconnected",h.Connecting="connecting",h.Connected="connected",h),b=((l=b||{}).Unsubscribed="unsubscribed",l.Subscribing="subscribing",l.Subscribed="subscribed",l);function f(e,t,s){e>31&&(e=31);let n=Math.floor(Math.random()*(Math.min(s,t*Math.pow(2,e))-0+1)+0);return Math.min(s,t+n)}var m=class extends d.default{constructor(e,t,s){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state="unsubscribed",this._clientwebsocket=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._delta="",this._delta_negotiated=!1,this._prevValue=null,this._unsubPromise=Promise.resolve(),this._setOptions(s),this._clientwebsocket._debugEnabled?(this.on("state",e=>{this._clientwebsocket._debug("subscription state",t,e.oldState,"->",e.newState)}),this.on("error",e=>{this._clientwebsocket._debug("subscription error",t,e)})):this.on("error",function(){Function.prototype()})}ready(e){return"unsubscribed"===this.state?Promise.reject({code:7,message:this.state}):"subscribed"===this.state?Promise.resolve():new Promise((t,s)=>{const n={resolve:t,reject:s};e&&(n.timeout=setTimeout(function(){s({code:1,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=n})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(0,"subscribe called"))}unsubscribe(){this._unsubPromise=this._setUnsubscribed(0,"unsubscribe called",!0)}publish(e){let t=this;return this._methodCall().then(function(){return t._clientwebsocket.publish(t.channel,e)})}presence(){let e=this;return this._methodCall().then(function(){return e._clientwebsocket.presence(e.channel)})}presenceStats(){let e=this;return this._methodCall().then(function(){return e._clientwebsocket.presenceStats(e.channel)})}history(e){let t=this;return this._methodCall().then(function(){return t._clientwebsocket.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:7,message:this.state}):new Promise((e,t)=>{const s={timeout:setTimeout(function(){t({code:1,message:"timeout"})},this._clientwebsocket._config.timeout),resolve:e,reject:t};this._promises[this._nextPromiseId()]=s})}_nextPromiseId(){return++this._promiseId}_needRecover(){return!0===this._recover}_isUnsubscribed(){return"unsubscribed"===this.state}_isSubscribing(){return"subscribing"===this.state}_isSubscribed(){return"subscribed"===this.state}_setState(e){if(this.state!==e){let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0}return!1}_usesToken(){return""!==this._token||null!==this._getToken}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),e.delta?this._delta_negotiated=!0:this._delta_negotiated=!1,this._setState("subscribed");let t=this._clientwebsocket._getSubscribeContext(this.channel,e);this.emit("subscribed",t),this._resolvePromises();let s=e.publications;if(s&&s.length>0)for(let e in s)s.hasOwnProperty(e)&&this._handlePublication(s[e]);!0===e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),Math.min(1e3*e.ttl,2147483647)))}async _setSubscribing(e,t){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState("subscribing")&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._clientwebsocket._transport&&this._clientwebsocket._transport.emulation()&&await this._unsubPromise,this._isSubscribing()&&this._subscribe())}_subscribe(){if(this._clientwebsocket._debug("subscribing on",this.channel),!this._clientwebsocket._transportIsOpen)return this._clientwebsocket._debug("delay subscribe on",this.channel,"till connected"),null;let e=this,t={channel:e.channel};return!this._usesToken()||this._token?e._getData?(e._getData(t).then(function(t){e._isSubscribing()&&(e._data=t,e._sendSubscribe(e._token))}),null):e._sendSubscribe(e._token):(this._getSubscriptionToken().then(function(s){if(e._isSubscribing()){if(!s)return void e._failUnauthorized();e._token=s,e._getData?e._getData(t).then(function(t){e._isSubscribing()&&(e._data=t,e._sendSubscribe(s))}):e._sendSubscribe(s)}}).catch(function(t){if(e._isSubscribing()){if(t instanceof O)return void e._failUnauthorized();e.emit("error",{type:"subscribeToken",channel:e.channel,error:{code:8,message:void 0!==t?t.toString():""}}),e._scheduleResubscribe()}}),null)}_sendSubscribe(e){if(!this._clientwebsocket._transportIsOpen)return null;const t={channel:this.channel};if(e&&(t.token=e),this._data&&(t.data=this._data),this._positioned&&(t.positioned=!0),this._recoverable&&(t.recoverable=!0),this._joinLeave&&(t.join_leave=!0),this._needRecover()){t.recover=!0;let e=this._getOffset();e&&(t.offset=e);let s=this._getEpoch();s&&(t.epoch=s)}this._delta&&(t.delta=this._delta);const s={subscribe:t};return this._inflight=!0,this._clientwebsocket._call(s).then(e=>{this._inflight=!1;let t=e.reply.subscribe;this._handleSubscribeResponse(t),e.next&&e.next()},e=>{this._inflight=!1,this._handleSubscribeError(e.error),e.next&&e.next()}),s}_handleSubscribeError(e){if(this._isSubscribing()){if(1===e.code)return void this._clientwebsocket._disconnect(3,"subscribe timeout",!0);this._subscribeError(e)}}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,t,s){if(this._isUnsubscribed())return Promise.resolve();let n=Promise.resolve();return this._isSubscribed()?(s&&(n=this._clientwebsocket._unsubscribe(this)),this._clearSubscribedState()):this._isSubscribing()&&(this._inflight&&s&&(n=this._clientwebsocket._unsubscribe(this)),this._clearSubscribingState()),this._setState("unsubscribed")&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:7,message:this.state}),n}_handlePublication(e){if(this._delta&&this._delta_negotiated){let{newData:t,newPrevValue:s}=this._clientwebsocket._codec.applyDeltaIfNeeded(e,this._prevValue);e.data=t,this._prevValue=s}let t=this._clientwebsocket._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){let t=this._clientwebsocket._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:t})}_handleLeave(e){let t=this._clientwebsocket._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:t})}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}_scheduleResubscribe(){let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe()},t)}_subscribeError(e){if(this._isSubscribing())if(e.code<100||109===e.code||!0===e.temporary){109===e.code&&(this._token="");const t={channel:this.channel,type:"subscribe",error:e};"connected"===this._clientwebsocket.state&&this.emit("error",t),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){let e=f(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){if(e&&(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),void 0!==e.minResubscribeDelay&&(this._minResubscribeDelay=e.minResubscribeDelay),void 0!==e.maxResubscribeDelay&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),!0===e.positioned&&(this._positioned=!0),!0===e.recoverable&&(this._recoverable=!0),!0===e.joinLeave&&(this._joinLeave=!0),e.delta)){if("fossil"!==e.delta)throw new Error("unsupported delta format");this._delta=e.delta}}_getOffset(){let e=this._offset;return null!==e?e:0}_getEpoch(){let e=this._epoch;return null!==e?e:""}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){null!==this._resubscribeTimeout&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._clientwebsocket._debug("get subscription token for channel",this.channel);const e={channel:this.channel};let t=this._getToken;if(null===t)throw this.emit("error",{type:"configuration",channel:this.channel,error:{code:12,message:"provide a function to get channel subscription token"}}),new O("");return t(e)}_refresh(){this._clearRefreshTimeout();let e=this;this._getSubscriptionToken().then(function(t){if(!e._isSubscribed())return;if(!t)return void e._failUnauthorized();e._token=t;const s={sub_refresh:{channel:e.channel,token:t}};e._clientwebsocket._call(s).then(t=>{let s=t.reply.sub_refresh;e._refreshResponse(s),t.next&&t.next()},t=>{e._refreshError(t.error),t.next&&t.next()})}).catch(function(t){t instanceof O?e._failUnauthorized():(e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:9,message:void 0!==t?t.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay()))})}_refreshResponse(e){this._isSubscribed()&&(this._clientwebsocket._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),!0===e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),Math.min(1e3*e.ttl,2147483647))))}_refreshError(e){this._isSubscribed()&&(e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return f(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(1,"unauthorized",!0)}},g=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return null!==this.options.sockjs}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},v=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return void 0!==this.options.websocket&&null!==this.options.websocket}initialize(e,t){let s="";"protobuf"===e&&(s="clientwebsocket-protobuf"),this._transport=""!==s?new this.options.websocket(this.endpoint,s):new this.options.websocket(this.endpoint),"protobuf"===e&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},w=class{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,t,s){let n=new EventTarget;return(0,e.options.fetch)(t,s).then(e._handleErrors).then(t=>{n.dispatchEvent(new Event("open"));let s="",i=0,r=new Uint8Array,o=t.body.getReader();return new e.options.readableStream({start:t=>function c(){return o.read().then(({done:o,value:a})=>{if(o)return n.dispatchEvent(new Event("close")),void t.close();try{if("json"===e._protocol)for(s+=e._utf8decoder.decode(a);i<s.length;)if("\n"===s[i]){const e={data:s.substring(0,i)};n.dispatchEvent(new MessageEvent("message",e)),s=s.substring(i+1),i=0}else++i;else{let t=new Uint8Array(r.length+a.length);for(t.set(r),t.set(a,r.length),r=t;;){let t=e.options.decoder.decodeReply(r);if(t.ok){const e={data:r.slice(0,t.pos)};n.dispatchEvent(new MessageEvent("message",e)),r=r.slice(t.pos);continue}break}}}catch(e){const s={detail:e};return n.dispatchEvent(new Event("error",s)),n.dispatchEvent(new Event("close")),void t.close()}c()}).catch(function(e){const s={detail:e};n.dispatchEvent(new Event("error",s)),n.dispatchEvent(new Event("close")),t.close()})}()})}).catch(e=>{const t={detail:e};n.dispatchEvent(new Event("error",t)),n.dispatchEvent(new Event("close"))}),n}supported(){return null!==this.options.fetch&&null!==this.options.readableStream&&typeof TextDecoder<"u"&&typeof AbortController<"u"&&typeof EventTarget<"u"&&typeof Event<"u"&&typeof MessageEvent<"u"&&typeof Error<"u"}initialize(e,t,s){let n,i;this._protocol=e,this._abortController=new AbortController,"json"===e?(n={Accept:"application/json","Content-Type":"application/json"},i=s):(n={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},i=s);const r={method:"POST",headers:n,body:i,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal};let o=this._fetchEventTarget(this,this.endpoint,r);o.addEventListener("open",()=>{t.onOpen()}),o.addEventListener("error",e=>{this._abortController.abort(),t.onError(e)}),o.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),o.addEventListener("message",e=>{t.onMessage(e.data)})}close(){this._abortController.abort()}send(e,t,s){const n={session:t,node:s,data:e};let i,r;"json"===this._protocol?(i={"Content-Type":"application/json"},r=JSON.stringify(n)):(i={"Content-Type":"application/octet-stream"},r=this.options.encoder.encodeEmulationRequest(n));const o={method:"POST",headers:i,body:r,mode:"cors",credentials:"same-origin",cache:"no-cache"};(0,this.options.fetch)(this.options.emulationEndpoint,o)}},y=class{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return null!==this.options.eventsource&&null!==this.options.fetch}initialize(e,t,s){let n;n=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint),n.searchParams.append("cf_connect",s);let i=new this.options.eventsource(n.toString(),{});this._transport=i;i.onopen=function(){t.onOpen()},i.onerror=function(e){i.close(),t.onError(e),t.onClose({code:4,reason:"connection closed"})},i.onmessage=function(e){t.onMessage(e.data)},this._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),null!==this._onClose&&this._onClose()}send(e,t,s){const n={session:t,node:s,data:e};let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),mode:"cors",credentials:"same-origin",cache:"no-cache"};(0,this.options.fetch)(this.options.emulationEndpoint,i)}},k=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return void 0!==this.options.webtransport&&null!==this.options.webtransport}async initialize(e,t){let s;s=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint),"protobuf"===e&&s.searchParams.append("cf_protocol","protobuf"),this._protocol=e;let n,i=new EventTarget;this._transport=new this.options.webtransport(s.toString()),this._transport.closed.then(()=>{t.onClose({code:4,reason:"connection closed"})}).catch(()=>{t.onClose({code:4,reason:"connection closed"})});try{await this._transport.ready}catch{return void this.close()}try{n=await this._transport.createBidirectionalStream()}catch{return void this.close()}this._stream=n,this._writer=this._stream.writable.getWriter(),i.addEventListener("close",()=>{t.onClose({code:4,reason:"connection closed"})}),i.addEventListener("message",e=>{t.onMessage(e.data)}),this._startReading(i),t.onOpen()}async _startReading(e){let t=this._stream.readable.getReader(),s="",n=0,i=new Uint8Array;try{for(;;){let{done:r,value:o}=await t.read();if(o.length>0)if("json"===this._protocol)for(s+=this._utf8decoder.decode(o);n<s.length;)if("\n"===s[n]){const t={data:s.substring(0,n)};e.dispatchEvent(new MessageEvent("message",t)),s=s.substring(n+1),n=0}else++n;else{let t=new Uint8Array(i.length+o.length);for(t.set(i),t.set(o,i.length),i=t;;){let t=this.options.decoder.decodeReply(i);if(t.ok){const s={data:i.slice(0,t.pos)};e.dispatchEvent(new MessageEvent("message",s)),i=i.slice(t.pos);continue}break}}if(r)break}}catch{e.dispatchEvent(new Event("close"))}}async close(){try{this._writer&&await this._writer.close(),this._transport.close()}catch{}}async send(e){let t;t="json"===this._protocol?(new TextEncoder).encode(e+"\n"):e;try{await this._writer.write(t)}catch{this.close()}}},T=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,36,-1,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,-1,-1,-1,63,-1],S=class{constructor(e){this.a=e,this.pos=0}haveBytes(){return this.pos<this.a.length}getByte(){let e=this.a[this.pos];if(this.pos++,this.pos>this.a.length)throw new RangeError("out of bounds");return e}getChar(){return String.fromCharCode(this.getByte())}getInt(){let e,t=0;for(;this.haveBytes()&&(e=T[127&this.getByte()])>=0;)t=(t<<6)+e;return this.pos--,t>>>0}},E=class{constructor(){this.a=[]}toByteArray(e){return Array.isArray(e)?this.a:new Uint8Array(this.a)}putArray(e,t,s){for(let n=t;n<s;n++)this.a.push(e[n])}};function x(e){let t=0,s=0,n=0,i=0,r=0,o=e.length;for(;o>=16;)t=t+e[r+0]|0,s=s+e[r+1]|0,n=n+e[r+2]|0,i=i+e[r+3]|0,t=t+e[r+4]|0,s=s+e[r+5]|0,n=n+e[r+6]|0,i=i+e[r+7]|0,t=t+e[r+8]|0,s=s+e[r+9]|0,n=n+e[r+10]|0,i=i+e[r+11]|0,t=t+e[r+12]|0,s=s+e[r+13]|0,n=n+e[r+14]|0,i=i+e[r+15]|0,r+=16,o-=16;for(;o>=4;)t=t+e[r+0]|0,s=s+e[r+1]|0,n=n+e[r+2]|0,i=i+e[r+3]|0,r+=4,o-=4;switch(i=((i+(n<<8)|0)+(s<<16)|0)+(t<<24)|0,o){case 3:i=i+(e[r+2]<<8)|0;case 2:i=i+(e[r+1]<<16)|0;case 1:i=i+(e[r+0]<<24)|0}return i>>>0}var C=class{name(){return"json"}encodeCommands(e){return e.map(e=>JSON.stringify(e)).join("\n")}decodeReplies(e){return e.trim().split("\n").map(e=>JSON.parse(e))}applyDeltaIfNeeded(e,t){let s,n;if(e.delta){let i=function(e,t){let s=0,n=new S(t),i=e.length,r=t.length,o=n.getInt();if("\n"!==n.getChar())throw new Error("size integer not terminated by '\\n'");let c=new E;for(;n.haveBytes();){let t,a=n.getInt();switch(n.getChar()){case"@":if(t=n.getInt(),n.haveBytes()&&","!==n.getChar())throw new Error("copy command not terminated by ','");if(s+=a,s>o)throw new Error("copy exceeds output file size");if(t+a>i)throw new Error("copy extends past end of input");c.putArray(e,t,t+a);break;case":":if(s+=a,s>o)throw new Error("insert command gives an output larger than predicted");if(a>r)throw new Error("insert count exceeds size of delta");c.putArray(n.a,n.pos,n.pos+a),n.pos+=a;break;case";":{let t=c.toByteArray(e);if(a!==x(t))throw new Error("bad checksum");if(s!==o)throw new Error("generated size does not match predicted size");return t}default:throw new Error("unknown delta operator")}}throw new Error("unterminated delta")}(t,(new TextEncoder).encode(e.data));s=JSON.parse((new TextDecoder).decode(i)),n=i}else s=JSON.parse(e.data),n=(new TextEncoder).encode(e.data);return{newData:s,newPrevValue:n}}},P=u(_()),R={token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null},O=class extends Error{constructor(e){super(e),this.name=this.constructor.name}},j=class extends P.default{constructor(e,t){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null;const s={...R,...t};this.state="disconnected",this._transportIsOpen=!1,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new C,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=s,this._configure(),this._debugEnabled?(this.on("state",e=>{this._debug("client state",e.oldState,"->",e.newState)}),this.on("error",e=>{this._debug("client error",e)})):this.on("error",function(){Function.prototype()})}listenTo(e,t){if(null!==this.getSubscription(e))throw new Error("Subscription to the channel "+e+" already exists");let s=new m(this,e,t);return this._subs[e]=s,s}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&("unsubscribed"!==e.state&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){return"disconnected"===this.state?Promise.reject({code:3,message:"client disconnected"}):"connected"===this.state?Promise.resolve():new Promise((t,s)=>{const n={resolve:t,reject:s};e&&(n.timeout=setTimeout(function(){s({code:1,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=n})}connect(){this._isConnected()?this._debug("connect called when already connected"):this._isConnecting()?this._debug("connect called when already connecting"):(this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting())}disconnect(){this._disconnect(0,"disconnect called",!1)}setToken(e){this._token=e}send(e){const t={send:{data:e}};let s=this;return this._methodCall().then(function(){return s._transportSendCommands([t])?Promise.resolve():Promise.reject(s._createErrorObject(10,"transport write error"))})}rpc(e,t){const s={rpc:{method:e,data:t}};let n=this;return this._methodCall().then(function(){return n._callPromise(s,function(e){return{data:e.rpc.data}})})}publish(e,t){const s={publish:{channel:e,data:t}};let n=this;return this._methodCall().then(function(){return n._callPromise(s,function(){return{}})})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){this._debugEnabled&&function(e,t){if(globalThis.console){let s=globalThis.console[e];null!=s&&"function"==typeof s&&s.apply(globalThis.console,t)}}("debug",e)}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(null!==this._config.token&&(this._token=this._config.token),null!==this._config.data&&(this._data=this._config.data),this._codec=new C,this._formatOverride(),(!0===this._config.debug||typeof localStorage<"u"&&localStorage.getItem("clientwebsocket.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),"string"!=typeof this._endpoint){if(!("object"==typeof this._endpoint&&this._endpoint instanceof Array))throw new Error("unsupported url configuration type: only string or array of objects are supported");this._transports=this._endpoint,this._emulation=!0;for(let e in this._transports)if(this._transports.hasOwnProperty(e)){let t=this._transports[e];if(!t.endpoint||!t.transport)throw new Error("malformed transport configuration");let s=t.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(s)<0)throw new Error("unsupported transport name: "+s)}}}_setState(e){if(this.state!==e){this._reconnecting=!1;let t=this.state;return this.state=e,this.emit("state",{newState:e,oldState:t}),!0}return!1}_isDisconnected(){return"disconnected"===this.state}_isConnecting(){return"connecting"===this.state}_isConnected(){return"connected"===this.state}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;null!==this._config.networkEventTarget?e=this._config.networkEventTarget:typeof globalThis.addEventListener<"u"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),"connected"!==this.state&&"connecting"!==this.state||(this._disconnect(1,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),"connecting"===this.state&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){let e=f(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(let e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){let t=this._callbacks[e];clearTimeout(t.timeout);let s=t.errback;if(!s)continue;s({error:this._createErrorObject(11,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(let e in this._subs){if(!this._subs.hasOwnProperty(e))continue;let t=this._subs[e];"subscribed"===t.state&&t._setSubscribing(1,"transport closed")}for(let e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(let t of e){let e=t.id;if(!(e in this._callbacks))continue;let s=this._callbacks[e];clearTimeout(this._callbacks[e].timeout),delete this._callbacks[e],(0,s.errback)({error:this._createErrorObject(10,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(t){return this._debug("error writing commands",t),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;null!==this._config.websocket?e=this._config.websocket:"function"!=typeof globalThis.WebSocket&&"object"!=typeof globalThis.WebSocket||(e=globalThis.WebSocket);let t=null;null!==this._config.sockjs?t=this._config.sockjs:typeof globalThis.SockJS<"u"&&(t=globalThis.SockJS);let s=null;null!==this._config.eventsource?s=this._config.eventsource:typeof globalThis.EventSource<"u"&&(s=globalThis.EventSource);let n=null;null!==this._config.fetch?n=this._config.fetch:typeof globalThis.fetch<"u"&&(n=globalThis.fetch);let i=null;if(null!==this._config.readableStream?i=this._config.readableStream:typeof globalThis.ReadableStream<"u"&&(i=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let r=0;for(;;){if(r>=this._transports.length)throw new Error("no supported transport found");let o=this._transports[this._currentTransportIndex],c=o.transport,a=o.endpoint;if("websocket"===c){const t={websocket:e};if(this._debug("trying websocket transport"),this._transport=new v(a,t),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,r++;continue}}else if("webtransport"===c){if(this._debug("trying webtransport transport"),this._transport=new k(a,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,r++;continue}}else if("http_stream"===c){if(this._debug("trying http_stream transport"),this._transport=new w(a,{fetch:n,readableStream:i,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,r++;continue}}else if("sse"===c){if(this._debug("trying sse transport"),this._transport=new y(a,{eventsource:s,fetch:n,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,r++;continue}}else{if("sockjs"!==c)throw new Error("unknown transport "+c);if(this._debug("trying sockjs"),this._transport=new g(a,{sockjs:t,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,r++;continue}}break}}else{if(0===this._endpoint.lastIndexOf("http",0))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");const t={websocket:e};if(this._debug("client will use websocket"),this._transport=new v(this._endpoint,t),!this._transport.supported())throw new Error("WebSocket not available")}let r=this,o=this._transport,c=this._nextTransportId();r._debug("id of transport",c);let a=!1,h=[];if(this._transport.emulation()){let e=r._sendConnect(!0);h.push(e)}this._setNetworkEvents();let l,u=this._codec.encodeCommands(h);this._transportClosed=!1,l=setTimeout(function(){o.close()},this._config.timeout),this._transport.initialize(this._codec.name(),{onOpen:function(){if(l&&(clearTimeout(l),l=null),r._transportId!=c)return r._debug("open callback from non-actual transport"),void o.close();a=!0,r._debug(o.subName(),"transport open"),o.emulation()||(r._transportIsOpen=!0,r._transportWasOpen=!0,r.startBatching(),r._sendConnect(!1),r._sendSubscribeCommands(),r.stopBatching(),r.emit("__clientwebsocket_debug:connect_frame_sent",{}))},onError:function(e){r._transportId==c?r._debug("transport level error",e):r._debug("error callback from non-actual transport")},onClose:function(e){if(l&&(clearTimeout(l),l=null),r._transportId!=c)return void r._debug("close callback from non-actual transport");r._debug(o.subName(),"transport closed"),r._transportClosed=!0,r._transportIsOpen=!1;let t="connection closed",s=!0,n=0;if(e&&"code"in e&&e.code&&(n=e.code),e&&e.reason)try{let n=JSON.parse(e.reason);t=n.reason,s=n.reconnect}catch{t=e.reason,(n>=3500&&n<4e3||n>=4500&&n<5e3)&&(s=!1)}n<3e3?(1009===n?(n=3,t="message size limit exceeded",s=!1):(n=1,t="transport closed"),r._emulation&&!r._transportWasOpen&&(r._currentTransportIndex++,r._currentTransportIndex>=r._transports.length&&(r._triedAllTransports=!0,r._currentTransportIndex=0))):r._transportWasOpen=!0,r._isConnecting()&&!a&&r.emit("error",{type:"transport",error:{code:2,message:"transport closed"},transport:o.name()}),r._reconnecting=!1,r._disconnect(n,t,s)},onMessage:function(e){r._dataReceived(e)}},u),r.emit("__clientwebsocket_debug:transport_initialized",{})}_sendConnect(e){let t=this._constructConnectCommand(),s=this;return this._call(t,e).then(e=>{let t=e.reply.connect;s._connectResponse(t),e.next&&e.next()},e=>{s._connectError(e.error),e.next&&e.next()}),t}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting())return void this._debug("stop reconnecting: client not in connecting state");if(this._reconnecting)return void this._debug("reconnect already in progress, return from reconnect routine");if(!1===this._transportClosed)return void this._debug("waiting for transport close");this._reconnecting=!0;let e=this,t=""===this._token;this._refreshRequired||t&&null!==this._config.getToken?this._getToken().then(function(t){if(e._isConnecting()){if(null==t||null==t)return void e._failUnauthorized();e._token=t,e._debug("connection token refreshed"),e._config.getData?e._config.getData().then(function(t){e._isConnecting()&&(e._data=t,e._initializeTransport())}):e._initializeTransport()}}).catch(function(t){if(!e._isConnecting())return;if(t instanceof O)return void e._failUnauthorized();e.emit("error",{type:"connectToken",error:{code:5,message:void 0!==t?t.toString():""}});let s=e._getReconnectDelay();e._debug("error on connection token refresh, reconnect after "+s+" milliseconds",t),e._reconnecting=!1,e._reconnectTimeout=setTimeout(()=>{e._startReconnecting()},s)}):this._config.getData?this._config.getData().then(function(t){e._isConnecting()&&(e._data=t,e._initializeTransport())}):this._initializeTransport()}_connectError(e){"connecting"===this.state&&(109===e.code&&(this._refreshRequired=!0),e.code<100||!0===e.temporary||109===e.code?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;!this._emulation||this._transportWasOpen||this._triedAllTransports||(e=!0);let t=this._getReconnectDelay();e&&(t=0),this._debug("reconnect after "+t+" milliseconds"),this._clearReconnectTimeout(),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},t)}_constructConnectCommand(){let e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version);let t={},s=!1;for(let e in this._serverSubs)if(this._serverSubs.hasOwnProperty(e)&&this._serverSubs[e].recoverable){s=!0;const n={recover:!0};this._serverSubs[e].offset&&(n.offset=this._serverSubs[e].offset),this._serverSubs[e].epoch&&(n.epoch=this._serverSubs[e].epoch),t[e]=n}return s&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){const s={channel:e};return void 0!==t&&(t.since&&(s.since={offset:t.since.offset},t.since.epoch&&(s.since.epoch=t.since.epoch)),void 0!==t.limit&&(s.limit=t.limit),!0===t.reverse&&(s.reverse=!0)),s}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{const s={timeout:setTimeout(function(){t({code:1,message:"timeout"})},this._config.timeout),resolve:e,reject:t};this._promises[this._nextPromiseId()]=s})}_callPromise(e,t){return new Promise((s,n)=>{this._call(e,!1).then(e=>{s(t(e.reply)),e.next&&e.next()},e=>{n(e.error),e.next&&e.next()})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();let t=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let e;this._dispatchPromise=new Promise(t=>{e=t}),this._dispatchSynchronized(t,e)})}_dispatchSynchronized(e,t){let s=Promise.resolve();for(let t in e)e.hasOwnProperty(t)&&(s=s.then(()=>this._dispatchReply(e[t])));s=s.then(()=>{t()})}_dispatchReply(e){let t,s=new Promise(e=>{t=e});if(null==e)return this._debug("dispatch: got undefined or null reply"),t(),s;let n=e.id;return n&&n>0?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),s}_call(e,t){return new Promise((s,n)=>{e.id=this._nextCommandId(),this._registerCall(e.id,s,n),t||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState("connecting")&&this.emit("connecting",{code:0,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,t,s){if(this._isDisconnected())return;this._transportIsOpen=!1;let n=this.state;this._reconnecting=!1;const i={code:e,reason:t};let r=!1;if(s?r=this._setState("connecting"):(r=this._setState("disconnected"),this._rejectPromises({code:3,message:"disconnected"})),this._clearOutgoingRequests(),"connecting"===n&&this._clearReconnectTimeout(),"connected"===n&&this._clearConnectedState(),r&&(this._isConnecting()?this.emit("connecting",i):this.emit("disconnected",i)),this._transport){this._debug("closing existing transport");let e=this._transport;this._transport=null,e.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(1,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),!this._config.getToken)throw this.emit("error",{type:"configuration",error:{code:12,message:"token expired but no getToken function set in the configuration"}}),new O("");return this._config.getToken({})}_refresh(){let e=this._client,t=this;this._getToken().then(function(s){if(e!==t._client)return;if(!s)return void t._failUnauthorized();if(t._token=s,t._debug("connection token refreshed"),!t._isConnected())return;const n={refresh:{token:t._token}};t._call(n,!1).then(e=>{let s=e.reply.refresh;t._refreshResponse(s),e.next&&e.next()},e=>{t._refreshError(e.error),e.next&&e.next()})}).catch(function(e){if(t._isConnected()){if(e instanceof O)return void t._failUnauthorized();t.emit("error",{type:"refreshToken",error:{code:6,message:void 0!==e?e.toString():""}}),t._refreshTimeout=setTimeout(()=>t._refresh(),t._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return f(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),Math.min(1e3*e.ttl,2147483647)))}_removeSubscription(e){null!==e&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._transportIsOpen)return Promise.resolve();const t={unsubscribe:{channel:e.channel}};let s=this;return new Promise((e,n)=>{this._call(t,!1).then(t=>{e(),t.next&&t.next()},t=>{e(),t.next&&t.next(),s._disconnect(4,"unsubscribe error",!0)})})}_getSub(e){return this._subs[e]||null}_isServerSub(e){return void 0!==this._serverSubs[e]}_sendSubscribeCommands(){let e=[];for(let t in this._subs){if(!this._subs.hasOwnProperty(t))continue;let s=this._subs[t];if(!0!==s._inflight&&"subscribing"===s.state){let t=s._subscribe();t&&e.push(t)}}return e}_connectResponse(e){if(this._transportIsOpen=!0,this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState("connected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),Math.min(1e3*e.ttl,2147483647))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(),this.stopBatching();let t={client:e.client,transport:this._transport.subName()};e.data&&(t.data=e.data),this.emit("connected",t),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=1e3*e.ping,this._sendPong=!0===e.pong,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let s=e[t];const n={offset:s.offset,epoch:s.epoch,recoverable:s.recoverable||!1};this._serverSubs[t]=n;let i=this._getSubscribeContext(t,s);this.emit("subscribed",i)}for(let t in e){if(!e.hasOwnProperty(t))continue;let s=e[t];if(s.recovered){let e=s.publications;if(e&&e.length>0)for(let s in e)e.hasOwnProperty(s)&&this._handlePublication(t,e[s])}}for(let t in this._serverSubs)this._serverSubs.hasOwnProperty(t)&&(e[t]||(this.emit("unsubscribed",{channel:t}),delete this._serverSubs[t]))}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){null!==this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){null!==this._serverPingTimeout&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){0!==this._config.maxServerPingDelay&&this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(2,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,t){const s={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1};t.recovered&&(s.recovered=!0),t.positioned&&(s.positioned=!0),t.recoverable&&(s.recoverable=!0),t.was_recovering&&(s.wasRecovering=!0);let n="";"epoch"in t&&(n=t.epoch);let i=0;return"offset"in t&&(i=t.offset),t.data&&(s.data=t.data),s}_handleReply(e,t){let s=e.id;if(!(s in this._callbacks))return void t();let n=this._callbacks[s];if(clearTimeout(this._callbacks[s].timeout),delete this._callbacks[s],"error"in e&&null!==e.error){let s=n.errback;if(!s)return void t();s({error:e.error,next:t})}else{let s=n.callback;if(!s)return;s({reply:e,next:t})}}_handleJoin(e,t){let s=this._getSub(e);if(s)s._handleJoin(t);else if(this._isServerSub(e)){let s={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("join",s)}}_handleLeave(e,t){let s=this._getSub(e);if(s)s._handleLeave(t);else if(this._isServerSub(e)){let s={channel:e,info:this._getJoinLeaveContext(t.info)};this.emit("leave",s)}}_handleUnsubscribe(e,t){let s=this._getSub(e);s?t.code<2500?s._setUnsubscribed(t.code,t.reason,!1):s._setSubscribing(t.code,t.reason):this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}))}_handleSubscribe(e,t){const s={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1};this._serverSubs[e]=s,this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,s=!0;(t>=3500&&t<4e3||t>=4500&&t<5e3)&&(s=!1),this._disconnect(t,e.reason,s)}_getPublicationContext(e,t){const s={channel:e};return s.data=t.data,t.offset&&(s.offset=t.offset),t.info&&(s.info=this._getJoinLeaveContext(t.info)),t.tags&&(s.tags=t.tags),s}_getJoinLeaveContext(e){const t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){let s=this._getSub(e);if(s)s._handlePublication(t);else if(this._isServerSub(e)){let s=this._getPublicationContext(e,t);this.emit("publication",s),void 0!==t.offset&&(this._serverSubs[e].offset=t.offset)}}_handleMessage(e){const t={data:e.data};this.emit("message",t)}_handleServerPing(e){if(this._sendPong){let e={};this._transportSendCommands([e])}e()}_handlePush(e,t){let s=e.channel;e.pub?this._handlePublication(s,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(s,e.join):e.leave?this._handleLeave(s,e.leave):e.unsubscribe?this._handleUnsubscribe(s,e.unsubscribe):e.subscribe?this._handleSubscribe(s,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){let e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,s){const n={code:e,message:t};return s&&(n.temporary=!0),n}_registerCall(e,t,s){const n={callback:t};n.errback=s,n.timeout=null,this._callbacks[e]=n,this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],null!=s&&"function"==typeof s&&s({error:this._createErrorObject(1,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(let e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(let t in this._promises)this._promises.hasOwnProperty(t)&&(this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t])}};globalThis.Drumie=class{constructor(e,t,s){if(!t?.token||"function"!=typeof t.token)throw new Error("Missing or invalid `token`: must be a function when creating a Client.");const n={getToken:t?.token};this.client=new j(e,n),this.connecting=t.connecting,this.connected=t.connected,this.disconnected=t.disconnected,this.client.on("connecting",e=>{this?.connecting&&"function"==typeof this?.connecting&&this?.connecting(e)}).on("connected",e=>{this?.connected&&"function"==typeof this?.connected&&this?.connected(e)}).on("disconnected",e=>{this?.disconnected&&"function"==typeof this?.disconnected&&this?.disconnected(e)}),s.forEach(e=>{if(!e?.token||"function"!=typeof e.token)throw new Error("Missing or invalid channel `token`: must be a function");const t=e.name,s={getToken:e?.token};this.client.listenTo(""+t,s).on("publication",function(t){e?.callbacks?.listen&&"function"==typeof e?.callbacks?.listen&&e?.callbacks?.listen(t)}).on("subscribing",function(t){e?.callbacks?.subscribing&&"function"==typeof e?.callbacks?.subscribing&&e?.callbacks?.subscribing(t)}).on("subscribed",function(t){e?.callbacks?.subscribed&&"function"==typeof e?.callbacks?.subscribed&&e?.callbacks?.subscribed(t)}).on("unsubscribed",function(t){e?.callbacks?.unsubscribed&&"function"==typeof e?.callbacks?.unsubscribed&&e?.callbacks?.unsubscribed(t)}).on("join",t=>{e?.callbacks?.join&&"function"==typeof e?.callbacks?.join&&e?.callbacks?.join(t)}).on("leave",t=>{e?.callbacks?.leave&&"function"==typeof e?.callbacks?.leave&&e?.callbacks?.leave(t)}).subscribe()})}subscribe(){this.client.connect()}getChannel(e){return this.client.getSubscription(e)}channels(){return this.client.subscriptions()}removeChannel(e){return this.client.removeSubscription(e)}disconnect(){return this.client.disconnect()}}})();